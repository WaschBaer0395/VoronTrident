[include chopper_tune.cfg]
# This file contains common pin mappings for the Fysetc Spider board.
# To use this config, the firmware should be compiled for the STM32F446.
# When calling "menuconfig", enable "extra low-level configuration setup"
# and select the "12MHz crystal" as clock reference
# For flashing, write the compiled klipper.bin to memory location 0x08000000

# See docs/Config_Reference.md for a description of parameters.

## Voron Design VORON2 300 Spider TMC2209 UART config

[respond]
[include mainsail.cfg]                  # Include configuration from mainsail.cfg file
[include CONFIGS/brusharm.cfg]
[include CONFIGS/toolhead.cfg]
[include CONFIGS/stepper_drivers.cfg]
[include CONFIGS/fans.cfg]
[include CONFIGS/temp_sensors.cfg]
[include CONFIGS/toolhead_leds.cfg]
[include CONFIGS/KAMP_Settings.cfg]
[include K-ShakeTune/*.cfg]
[include MACROS/*.cfg]
[include shell_command.cfg]

#[include mmu/base/*.cfg]
#[include mmu/optional/client_macros.cfg]
#[include mmu/addons/blobifier.cfg]

[exclude_object]

[mcu]
#serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_4A001D001851303439363932-if00
serial: /dev/ttyAMA0
restart_method: command

[mcu NH36]
serial: /dev/serial/by-id/usb-Klipper_rp2040_4E363334320EA5B9-if00
restart_method: command

#[mcu easybrd]
#serial: /dev/serial/by-id/usb-Klipper_samd21g18a_766557303338585020312E31322F08FF-if00
#restart_method: command

[printer]                             # Printer configuration
kinematics: corexy                    # Printer type: corexy
max_velocity: 600                     # Maximum velocity (max 300)
max_accel: 50000                      # Maximum acceleration (max 4000)
max_z_velocity: 50                    # Maximum Z-axis velocity
max_z_accel: 100                      # Maximum Z-axis acceleration
#minimum_cruise_ratio: 0.5             # Default 0.5
square_corner_velocity: 25            # or ? 25 Square corner velocity

[input_shaper]
#shaper_freq_x: 71.4
#shaper_type_x: mzv
#shaper_freq_y: 49.4
#shaper_type_y: mzv

[skew_correction]

[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results
number_of_results_to_keep: 3
show_macros_in_webui: True

[virtual_sdcard]
path: ~/printer_data/gcodes

[display_status]

[pause_resume]

[gcode_arcs]
resolution: 0.5 


#####################################################################
#      X/Y Stepper Settings
#####################################################################

[stepper_x]
##	Connected to X-MOT (B Motor)
step_pin: PE11
dir_pin: PE10
enable_pin: !PE9
rotation_distance: 40 #39.9
microsteps: 32 #32
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin:  ^NH36:gpio13
position_min: 0
position_endstop: 299.5
position_max: 300.5
homing_speed: 100  #Max 100
second_homing_speed: 20
homing_retract_speed: 100
homing_retract_dist: 5
homing_positive_dir: true

[stepper_y]
##	Connected to Y-MOT (A Motor)
step_pin: PD8
dir_pin: PB12
enable_pin: !PD9
rotation_distance: 40 #39.95
microsteps: 32 #32
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: ^PB13 #tmc2209_stepper_y:virtual_endstop
position_min: 0
position_endstop: 308.5
position_max: 308.5
homing_speed: 100  #Max 100
second_homing_speed: 20
homing_retract_speed: 100
homing_retract_dist: 5
homing_positive_dir: true

[stepper_z]
step_pin: PE2
dir_pin: !PE4
enable_pin: !PE3
rotation_distance: 4
full_steps_per_rotation: 200
microsteps: 32
endstop_pin: probe:z_virtual_endstop # use cartographer as virtual endstop
homing_retract_dist: 0
position_max: 241
position_min: -10.5
homing_speed: 20


[stepper_z1]
step_pin: PD12
dir_pin: !PC4
enable_pin: !PE8
rotation_distance: 4
full_steps_per_rotation: 200
microsteps: 32

[stepper_z2]
step_pin: PE6
dir_pin: !PC13
enable_pin: !PE5
rotation_distance: 4
full_steps_per_rotation: 200
microsteps: 32

#####################################################################
#   Bed Heater
#####################################################################
[heater_bed]
heater_pin: PB4
sensor_type: NTC 100K MGB18-104F39050L32 #Generic 3950 #NTC 100K MGB18-104F39050L32
sensor_pin: PC0 # Spider v2.x
max_power: 0.8
min_temp: 5
max_temp: 125
#control: pid
#pid_kp: 32.475
#pid_ki: 1.012
#pid_kd: 260.615

#####################################################################
#	LED Control
#####################################################################
[output_pin Chamber_LED]
pin: PC8
pwm:true
shutdown_value: 0
value:0.1                             #the brightness at startup (0-1)
cycle_time: 0.0005
#scale: 0.15

#####################################################################
#	Displays
#####################################################################

#[display]
#	mini12864 LCD Display
#lcd_type: uc1701
#cs_pin: PC11
#a0_pin: PD2
#rst_pin: PC10
#encoder_pins: ^PC6,^PC7
#click_pin: ^!PA8
#contrast: 63
#spi_bus: spi1
#spi_software_mosi_pin: PA7
#spi_software_miso_pin: PA6
#spi_software_sclk_pin: PA5

#####################################################################
#	Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

#simply to remove the messages about t0 and t1 not being recognized in the console
[gcode_macro T0]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T0"
    # do nothing
[gcode_macro T1]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T1"
    # do nothing
[gcode_macro T2]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T2"
    # do nothing    
[gcode_macro T3]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T3"
    # do nothing
[gcode_macro T4]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T4"
    # do nothing    
[gcode_macro T5]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T5"
    # do nothing    
[gcode_macro T6]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T6"
    # do nothing
[gcode_macro T7]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T7"
    # do nothing    
[gcode_macro T8]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T8"
    # do nothing    
[gcode_macro T9]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T9"
    # do nothing    
[gcode_macro T10]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T10"
    # do nothing    

#####################################################################
##                  Bed Mesh Calibration
#####################################################################
[bed_mesh]
speed: 400                       # Calibration speed
horizontal_move_z: 10            # Z-axis movement speed
mesh_min: 20,35                  # Minimum calibration point coordinates x, y 0 , 0
mesh_max: 280,270                # Maximum calibration point coordinates x, y 300, 293
probe_count: 35,35              # Number of sampling points (7X7 is 49 points)
mesh_pps: 0,0                    # Additional sampling points
adaptive_margin: 10
zero_reference_position: 150,150

####################################################################################
##                                    Homing Override
####################################################################################

#[safe_z_home]
#home_xy_position: 150, 150
#z_hop: 10

#[homing_override]
#axes: z                    # Override homing for the Z axis only
#set_position_z: 0           # Set the Z position to 0 after homing
#gcode:
#    G90                     # Set to absolute positioning mode
#    G0 Z10 F1200            # Move Z axis to 10mm above the bed at 1200 mm/min
#    G28 X                   # Home X axis
#    G28 Y                   # Home Y axis
#    G1 X150 Y150 F7200      # Move to a specific coordinate (125, 125) at 7200 mm/min
#    G28 Z                   # Home Z axis again

[homing_override]
axes: xyz
set_position_z: 0
gcode:
  {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}
  STATUS_LEVELING
  G90                     # Set to absolute positioning mode
  G0 Z10 F1200            # Move Z axis to 10mm above the bed at 1200 mm/min

  {% if home_all or 'X' in params %}
    _HOME_X
  {% endif %}
  
  {% if home_all or 'Y' in params %}
    _HOME_Y
  {% endif %}
  
  {% if home_all or 'Z' in params %}
    STATUS_CALIBRATING_Z
    G90
    G1 X150 Y150 F4500
    G28 Z
    G1 Z10
  {% endif %}

[gcode_macro _HOME_X]
gcode:
    SAVE_GCODE_STATE NAME=STATE_HOME_X
    # Always use consistent run_current on A/B steppers during sensorless homing
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2240 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2240 stepper_y'].run_current|float %}
    {% set HOME_CURRENT = 0.5 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}

    # Home
    G28 X
    # Move away
    G91
    G1 X-80 F6000
    
    # Wait just a second… (give StallGuard registers time to clear)
    G4 P1000
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    RESTORE_GCODE_STATE NAME=STATE_HOME_X

[gcode_macro _HOME_Y]
gcode:
    SAVE_GCODE_STATE NAME=STATE_HOME_Y
    # Set current for sensorless homing
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2240 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2240 stepper_y'].run_current|float %}
    {% set HOME_CURRENT = 0.5 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}

    # Home
    G28 Y
    # Move away
    G91
    G1 Y-150 F6000

    # Wait just a second… (give StallGuard registers time to clear)
    G4 P1000
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    RESTORE_GCODE_STATE NAME=STATE_HOME_Y


####################################################################################
##                                    Z Tilt Adjustment
####################################################################################
[z_tilt]
##  Use Z_TILT_ADJUST to level the bed.
##  z_positions: Location of toolhead

## Uncomment below for 300mm build
z_positions:
   -50, 18
   150, 348
   350, 18
points:
   30, 10
   150, 250
   270, 10

## Uncomment below for 300mm build
#z_positions:
#   -50, 18
#   150, 348
#   350, 18
#points:
#   30, 5
#   150, 245
#   270, 5


speed: 250                 # Speed of Z tilt adjustment
horizontal_move_z: 2       # Z axis move speed for adjustments
retries: 10                # Number of retries for adjustment points
retry_tolerance: 0.0075    # Retry tolerance for adjustment accuracy

[gcode_macro Z_TILT_ADJUST]
rename_existing: BASE_Z_TILT_ADJUST
gcode:
    # Pass 1: Initial Coarse Leveling
    BASE_Z_TILT_ADJUST HORIZONTAL_MOVE_Z=10 RETRY_TOLERANCE=1
    # Pass 2: Fine Leveling and Accuracy
    BASE_Z_TILT_ADJUST HORIZONTAL_MOVE_Z=2

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_freq_x = 71.4
#*# shaper_type_x = mzv
#*# shaper_freq_y = 49.4
#*# shaper_type_y = mzv
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 32.475
#*# pid_ki = 1.012
#*# pid_kd = 260.615
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 41.329
#*# pid_ki = 4.305
#*# pid_kd = 99.192
#*#
#*# [axis_twist_compensation]
#*# z_compensations = 0.035147, 0.004554, -0.018615, -0.020978, -0.000109
#*# compensation_start_x = 20.0
#*# compensation_end_x = 280.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.032944, 0.041179, 0.039376, 0.040914, 0.042447, 0.040682, 0.042190, 0.047027, 0.043549, 0.046759, 0.044955, 0.049772, 0.042954, 0.049405, 0.042570, 0.045731, 0.035609, 0.038738, 0.028554, 0.031734, 0.018172, 0.017988, 0.004395
#*# 	  0.036296, 0.047851, 0.039376, 0.047576, 0.042447, 0.047335, 0.042190, 0.050359, 0.045227, 0.053376, 0.044955, 0.051440, 0.042972, 0.049405, 0.039289, 0.047384, 0.033926, 0.038721, 0.025220, 0.025037, 0.014832, 0.011254, 0.000994
#*# 	  0.032923, 0.047851, 0.039376, 0.044264, 0.039114, 0.048974, 0.040508, 0.052014, 0.041889, 0.053376, 0.041640, 0.053074, 0.039657, 0.049405, 0.035955, 0.045731, 0.028939, 0.037064, 0.021882, 0.025037, 0.011480, 0.011296, -0.002377
#*# 	  0.026209, 0.037837, 0.032693, 0.037576, 0.032433, 0.040647, 0.035510, 0.047009, 0.036908, 0.046759, 0.038286, 0.046466, 0.032985, 0.042788, 0.032635, 0.039071, 0.027272, 0.032066, 0.018539, 0.021699, 0.008089, 0.009597, -0.009125
#*# 	  0.022826, 0.031123, 0.029341, 0.030893, 0.029093, 0.037313, 0.032172, 0.043731, 0.031910, 0.043409, 0.031640, 0.043155, 0.029656, 0.039456, 0.025955, 0.032468, 0.018907, 0.025404, 0.011805, 0.014974, -0.002009, -0.000487, -0.019286
#*# 	  0.016087, 0.024392, 0.022623, 0.030893, 0.024041, 0.037313, 0.028812, 0.040372, 0.028554, 0.040110, 0.031640, 0.038166, 0.022984, 0.036160, 0.019274, 0.027455, 0.012173, 0.015383, 0.001771, 0.001545, -0.008757, -0.012326, -0.026088
#*# 	  0.012707, 0.017655, 0.019222, 0.027541, 0.020686, 0.027292, 0.023792, 0.027029, 0.021889, 0.026772, 0.023297, 0.026506, 0.019642, 0.026139, 0.015934, 0.015750, 0.008858, 0.005278, 0.001729, -0.001826, -0.008757, -0.015751, -0.022727
#*# 	  0.012707, 0.017655, 0.019222, 0.024149, 0.020686, 0.020567, 0.023813, 0.020337, 0.023541, 0.018392, 0.018264, 0.016485, 0.016259, 0.012745, 0.014237, 0.009007, 0.008823, 0.001912, 0.001729, -0.008616, -0.012142, -0.024224, -0.029490
#*# 	  0.009322, 0.015971, 0.015851, 0.017464, 0.019023, 0.017223, 0.022137, 0.018638, 0.021889, 0.016716, 0.016609, 0.013091, 0.019642, 0.012745, 0.015913, 0.005681, 0.008823, -0.001458, 0.001729, -0.011958, -0.012142, -0.029349, -0.032946
#*# 	  0.005933, 0.014287, 0.012483, 0.014073, 0.015643, 0.015526, 0.018780, 0.016945, 0.018495, 0.013363, 0.018285, 0.009777, 0.016301, 0.007711, 0.009225, 0.002280, 0.003800, -0.004848, -0.008390, -0.022134, -0.022317, -0.036180, -0.043207
#*# 	  0.009322, 0.010907, 0.015851, 0.012367, 0.018988, 0.015505, 0.022095, 0.015265, 0.021847, 0.013345, 0.021625, 0.008078, 0.012950, 0.002668, 0.002463, -0.001091, -0.004643, -0.011612, -0.018551, -0.027281, -0.032578, -0.039646, -0.050120
#*# 	  0.009322, 0.007522, 0.015851, 0.010701, 0.017326, 0.013843, 0.018780, 0.013619, 0.018495, 0.011682, 0.014933, 0.003014, 0.006197, -0.004092, -0.000907, -0.007839, -0.011407, -0.018368, -0.025396, -0.032352, -0.039412, -0.043045, -0.053555
#*# 	  0.009280, 0.005806, 0.012483, 0.010662, 0.012251, 0.010494, 0.012018, 0.010218, 0.011784, 0.006618, 0.008180, -0.000356, -0.000540, -0.004092, -0.005965, -0.011224, -0.016508, -0.018389, -0.028755, -0.028981, -0.039462, -0.046499, -0.053555
#*# 	  0.005898, 0.000746, 0.009103, 0.007303, 0.012251, 0.007083, 0.008648, 0.006848, 0.008418, 0.003248, 0.004814, -0.003724, -0.003908, -0.010899, -0.011061, -0.018021, -0.021625, -0.021809, -0.032211, -0.032394, -0.046272, -0.053328, -0.060454
#*# 	  -0.000853, -0.002696, 0.005676, 0.003876, 0.008883, 0.003703, 0.008648, 0.003479, 0.005048, -0.000121, 0.001444, -0.007104, -0.007288, -0.014246, -0.014447, -0.021442, -0.025029, -0.028614, -0.035629, -0.039228, -0.046315, -0.053371, -0.063928
#*# 	  -0.004299, -0.002696, -0.001058, 0.000529, 0.002119, 0.000297, 0.001900, 0.000099, 0.001679, -0.003522, -0.005304, -0.010489, -0.014062, -0.017654, -0.017816, -0.024845, -0.025007, -0.035445, -0.039044, -0.044393, -0.049752, -0.056818, -0.067365
#*# 	  -0.007701, -0.006099, -0.004457, -0.002900, -0.001306, -0.003106, -0.001528, -0.003285, -0.005106, -0.006885, -0.008689, -0.013878, -0.015773, -0.017654, -0.021237, -0.028204, -0.028430, -0.035445, -0.039044, -0.047825, -0.053187, -0.060270, -0.067365
#*# 	  -0.011114, -0.009501, -0.007903, -0.006299, -0.008057, -0.006500, -0.004910, -0.006692, -0.008510, -0.010275, -0.012114, -0.017308, -0.022571, -0.024478, -0.028063, -0.031660, -0.036969, -0.042310, -0.045948, -0.053003, -0.060086, -0.068936, -0.074346
#*# 	  -0.011114, -0.012914, -0.011304, -0.009703, -0.011503, -0.013260, -0.011703, -0.011782, -0.013582, -0.013683, -0.018885, -0.024089, -0.027695, -0.031292, -0.034894, -0.038493, -0.042105, -0.047457, -0.052820, -0.059902, -0.066997, -0.074112, -0.081297
#*# 	  -0.014532, -0.016332, -0.014717, -0.016517, -0.018317, -0.016704, -0.018465, -0.016907, -0.018707, -0.020464, -0.025712, -0.027512, -0.034527, -0.038176, -0.041759, -0.045375, -0.049017, -0.056083, -0.059719, -0.066814, -0.073928, -0.081114, -0.091764
#*# 	  -0.021396, -0.023218, -0.021551, -0.023351, -0.025151, -0.023536, -0.025339, -0.023721, -0.025521, -0.027343, -0.032543, -0.034343, -0.041370, -0.043291, -0.048600, -0.048834, -0.055899, -0.059557, -0.066630, -0.070273, -0.077455, -0.088084, -0.098765
#*# 	  -0.028237, -0.026607, -0.028411, -0.026822, -0.028579, -0.030379, -0.030494, -0.030605, -0.034069, -0.034155, -0.039386, -0.041186, -0.048232, -0.051901, -0.055532, -0.059168, -0.066263, -0.068202, -0.077037, -0.079009, -0.087900, -0.095075, -0.105785
#*# 	  -0.028263, -0.030063, -0.031841, -0.030254, -0.032054, -0.030400, -0.032225, -0.034025, -0.035804, -0.037626, -0.042840, -0.048049, -0.049979, -0.051901, -0.058984, -0.062617, -0.069747, -0.069906, -0.077088, -0.080746, -0.091397, -0.095075, -0.105837
#*# 	  -0.028288, -0.031784, -0.031841, -0.033641, -0.035492, -0.037241, -0.037377, -0.037458, -0.042670, -0.044445, -0.049691, -0.051534, -0.058617, -0.055348, -0.065895, -0.066079, -0.073244, -0.076879, -0.084049, -0.084233, -0.094891, -0.098581, -0.109358
#*# min_x = 94.42
#*# min_y = 90.17
#*# max_x = 205.58
#*# max_y = 205.83
#*# x_count = 23
#*# y_count = 24
#*# mesh_x_pps = 0
#*# mesh_y_pps = 0
#*# algo = bicubic
#*# tension = 0.2
#*#
#*# [cartographer scan_model default]
#*# coefficients = 1.4409646153265558,1.919197424113448,0.8571935870808074,0.41993384838137965,0.38750915051252216,0.4038583397037419,-0.13471668025995048,-0.285877455006765,0.2506859237579534,0.24614886855284263
#*# domain = 3.24103401852879e-07,3.359738087586886e-07
#*# z_offset = 0
#*# reference_temperature = 24.97
#*#
#*# [cartographer touch_model default]
#*# threshold = 1500
#*# speed = 2.0
#*# z_offset = -0.03
#*#
#*# [cartographer]
#*# z_backlash = 0.00528
