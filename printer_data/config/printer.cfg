[include chopper_tune.cfg]
# This file contains common pin mappings for the Fysetc Spider board.
# To use this config, the firmware should be compiled for the STM32F446.
# When calling "menuconfig", enable "extra low-level configuration setup"
# and select the "12MHz crystal" as clock reference
# For flashing, write the compiled klipper.bin to memory location 0x08000000

# See docs/Config_Reference.md for a description of parameters.

## Voron Design VORON2 300 Spider TMC2209 UART config

[respond]
[include mainsail.cfg]                  # Include configuration from mainsail.cfg file
[include CONFIGS/brusharm.cfg]
[include CONFIGS/toolhead.cfg]
[include CONFIGS/stepper_drivers.cfg]
[include CONFIGS/fans.cfg]
[include CONFIGS/temp_sensors.cfg]
[include CONFIGS/toolhead_leds.cfg]
[include CONFIGS/KAMP_Settings.cfg]
[include K-ShakeTune/*.cfg]
[include MACROS/*.cfg]
[include shell_command.cfg]

#[include mmu/base/*.cfg]
#[include mmu/optional/client_macros.cfg]
#[include mmu/addons/blobifier.cfg]

[exclude_object]

[mcu]
#serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_4A001D001851303439363932-if00
serial: /dev/ttyAMA0
restart_method: command

[mcu NH36]
serial: /dev/serial/by-id/usb-Klipper_rp2040_4E363334320EA5B9-if00
restart_method: command

#[mcu easybrd]
#serial: /dev/serial/by-id/usb-Klipper_samd21g18a_766557303338585020312E31322F08FF-if00
#restart_method: command

[printer]                             # Printer configuration
kinematics: corexy                    # Printer type: corexy
max_velocity: 600                     # Maximum velocity (max 300)
max_accel: 50000                      # Maximum acceleration (max 4000)
max_z_velocity: 50                    # Maximum Z-axis velocity
max_z_accel: 100                      # Maximum Z-axis acceleration
#minimum_cruise_ratio: 0.5             # Default 0.5
square_corner_velocity: 25            # or ? 25 Square corner velocity

[input_shaper]
#shaper_freq_x: 71.4
#shaper_type_x: mzv
#shaper_freq_y: 49.4
#shaper_type_y: mzv

[skew_correction]

[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results
number_of_results_to_keep: 3
show_macros_in_webui: True

[virtual_sdcard]
path: ~/printer_data/gcodes

[display_status]

[pause_resume]

[gcode_arcs]
resolution: 0.5 


#####################################################################
#      X/Y Stepper Settings
#####################################################################

[stepper_x]
##	Connected to X-MOT (B Motor)
step_pin: PE11
dir_pin: PE10
enable_pin: !PE9
rotation_distance: 40 #39.9
microsteps: 32 #32
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin:  ^NH36:gpio13
position_min: 0
position_endstop: 299.5
position_max: 300.5
homing_speed: 100  #Max 100
second_homing_speed: 20
homing_retract_speed: 100
homing_retract_dist: 5
homing_positive_dir: true

[stepper_y]
##	Connected to Y-MOT (A Motor)
step_pin: PD8
dir_pin: PB12
enable_pin: !PD9
rotation_distance: 40 #39.95
microsteps: 32 #32
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: ^PB13 #tmc2209_stepper_y:virtual_endstop
position_min: 0
position_endstop: 308.5
position_max: 308.5
homing_speed: 100  #Max 100
second_homing_speed: 20
homing_retract_speed: 100
homing_retract_dist: 5
homing_positive_dir: true

[stepper_z]
step_pin: PE2
dir_pin: !PE4
enable_pin: !PE3
rotation_distance: 4
full_steps_per_rotation: 200
microsteps: 16
endstop_pin: probe:z_virtual_endstop # use cartographer as virtual endstop
homing_retract_dist: 0
position_max: 241
position_min: -10.5
homing_speed: 20


[stepper_z1]
step_pin: PD12
dir_pin: !PC4
enable_pin: !PE8
rotation_distance: 4
full_steps_per_rotation: 200
microsteps: 16

[stepper_z2]
step_pin: PE6
dir_pin: !PC13
enable_pin: !PE5
rotation_distance: 4
full_steps_per_rotation: 200
microsteps: 16

#####################################################################
#   Bed Heater
#####################################################################
[heater_bed]
heater_pin: PB4
sensor_type: NTC 100K MGB18-104F39050L32 #Generic 3950 #NTC 100K MGB18-104F39050L32
sensor_pin: PC0 # Spider v2.x
max_power: 0.8
min_temp: 5
max_temp: 125
#control: pid
#pid_kp: 32.475
#pid_ki: 1.012
#pid_kd: 260.615

#####################################################################
#	LED Control
#####################################################################
[output_pin Chamber_LED]
pin: PC8
pwm:true
shutdown_value: 0
value:0.1                             #the brightness at startup (0-1)
cycle_time: 0.0005
#scale: 0.15

#####################################################################
#	Displays
#####################################################################

#[display]
#	mini12864 LCD Display
#lcd_type: uc1701
#cs_pin: PC11
#a0_pin: PD2
#rst_pin: PC10
#encoder_pins: ^PC6,^PC7
#click_pin: ^!PA8
#contrast: 63
#spi_bus: spi1
#spi_software_mosi_pin: PA7
#spi_software_miso_pin: PA6
#spi_software_sclk_pin: PA5

#####################################################################
#	Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

#simply to remove the messages about t0 and t1 not being recognized in the console
[gcode_macro T0]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T0"
    # do nothing
[gcode_macro T1]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T1"
    # do nothing
[gcode_macro T2]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T2"
    # do nothing    
[gcode_macro T3]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T3"
    # do nothing
[gcode_macro T4]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T4"
    # do nothing    
[gcode_macro T5]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T5"
    # do nothing    
[gcode_macro T6]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T6"
    # do nothing
[gcode_macro T7]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T7"
    # do nothing    
[gcode_macro T8]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T8"
    # do nothing    
[gcode_macro T9]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T9"
    # do nothing    
[gcode_macro T10]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T10"
    # do nothing    

#####################################################################
##                  Bed Mesh Calibration
#####################################################################
[bed_mesh]
speed: 400                       # Calibration speed
horizontal_move_z: 10            # Z-axis movement speed
mesh_min: 20,35                  # Minimum calibration point coordinates x, y 0 , 0
mesh_max: 280,270                # Maximum calibration point coordinates x, y 300, 293
probe_count: 35,35              # Number of sampling points (7X7 is 49 points)
mesh_pps: 0,0                    # Additional sampling points
adaptive_margin: 10
zero_reference_position: 150,150

####################################################################################
##                                    Homing Override
####################################################################################

#[safe_z_home]
#home_xy_position: 150, 150
#z_hop: 10

#[homing_override]
#axes: z                    # Override homing for the Z axis only
#set_position_z: 0           # Set the Z position to 0 after homing
#gcode:
#    G90                     # Set to absolute positioning mode
#    G0 Z10 F1200            # Move Z axis to 10mm above the bed at 1200 mm/min
#    G28 X                   # Home X axis
#    G28 Y                   # Home Y axis
#    G1 X150 Y150 F7200      # Move to a specific coordinate (125, 125) at 7200 mm/min
#    G28 Z                   # Home Z axis again

[homing_override]
axes: xyz
set_position_z: 0
gcode:
  {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}
  STATUS_LEVELING
  G90                     # Set to absolute positioning mode
  G0 Z10 F1200            # Move Z axis to 10mm above the bed at 1200 mm/min

  {% if home_all or 'X' in params %}
    _HOME_X
  {% endif %}
  
  {% if home_all or 'Y' in params %}
    _HOME_Y
  {% endif %}
  
  {% if home_all or 'Z' in params %}
    STATUS_CALIBRATING_Z
    G90
    G1 X150 Y150 F4500
    G28 Z
    G1 Z10
  {% endif %}

[gcode_macro _HOME_X]
gcode:
    SAVE_GCODE_STATE NAME=STATE_HOME_X
    # Always use consistent run_current on A/B steppers during sensorless homing
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2240 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2240 stepper_y'].run_current|float %}
    {% set HOME_CURRENT = 0.5 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}

    # Home
    G28 X
    # Move away
    G91
    G1 X-80 F6000
    
    # Wait just a second… (give StallGuard registers time to clear)
    G4 P1000
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    RESTORE_GCODE_STATE NAME=STATE_HOME_X

[gcode_macro _HOME_Y]
gcode:
    SAVE_GCODE_STATE NAME=STATE_HOME_Y
    # Set current for sensorless homing
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2240 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2240 stepper_y'].run_current|float %}
    {% set HOME_CURRENT = 0.5 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}

    # Home
    G28 Y
    # Move away
    G91
    G1 Y-150 F6000

    # Wait just a second… (give StallGuard registers time to clear)
    G4 P1000
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    RESTORE_GCODE_STATE NAME=STATE_HOME_Y


####################################################################################
##                                    Z Tilt Adjustment
####################################################################################
[z_tilt]
##  Use Z_TILT_ADJUST to level the bed.
##  z_positions: Location of toolhead

## Uncomment below for 300mm build
z_positions:
   -50, 18
   150, 348
   350, 18
points:
   30, 10
   150, 250
   270, 10

## Uncomment below for 300mm build
#z_positions:
#   -50, 18
#   150, 348
#   350, 18
#points:
#   30, 5
#   150, 245
#   270, 5


speed: 250                 # Speed of Z tilt adjustment
horizontal_move_z: 2       # Z axis move speed for adjustments
retries: 10                # Number of retries for adjustment points
retry_tolerance: 0.0075    # Retry tolerance for adjustment accuracy

[gcode_macro Z_TILT_ADJUST]
rename_existing: BASE_Z_TILT_ADJUST
gcode:
    # Pass 1: Initial Coarse Leveling
    BASE_Z_TILT_ADJUST HORIZONTAL_MOVE_Z=10 RETRY_TOLERANCE=1
    # Pass 2: Fine Leveling and Accuracy
    BASE_Z_TILT_ADJUST HORIZONTAL_MOVE_Z=2

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_freq_x = 71.4
#*# shaper_type_x = mzv
#*# shaper_freq_y = 49.4
#*# shaper_type_y = mzv
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 32.475
#*# pid_ki = 1.012
#*# pid_kd = 260.615
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 41.329
#*# pid_ki = 4.305
#*# pid_kd = 99.192
#*#
#*# [axis_twist_compensation]
#*# z_compensations = 0.035147, 0.004554, -0.018615, -0.020978, -0.000109
#*# compensation_start_x = 20.0
#*# compensation_end_x = 280.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.008917, 0.016256, 0.016753, 0.030864, 0.026770, 0.034048, 0.036721, 0.037212, 0.037661, 0.040359, 0.039669, 0.043443, 0.043871, 0.042869, 0.042684, 0.042499, 0.044538, 0.044376, 0.041943, 0.030494, 0.028052, 0.018845, 0.013024, 0.004861, -0.003330, -0.009210
#*# 	0.007763, 0.016299, 0.019065, 0.024066, 0.026813, 0.030663, 0.034479, 0.034950, 0.034267, 0.033579, 0.036239, 0.041191, 0.039373, 0.037244, 0.038186, 0.040253, 0.040021, 0.039883, 0.032981, 0.029366, 0.021301, 0.016599, 0.005025, 0.002575, -0.005622, -0.023032
#*# 	-0.000317, 0.014001, 0.012183, 0.022904, 0.026770, 0.026114, 0.029962, 0.032682, 0.029733, 0.029050, 0.032872, 0.034425, 0.037119, 0.033907, 0.038233, 0.035747, 0.037816, 0.035376, 0.032960, 0.024862, 0.021301, 0.009793, 0.006189, -0.002000, -0.010194, -0.021877
#*# 	0.004343, 0.011662, 0.015586, 0.019496, 0.024514, 0.028368, 0.027687, 0.029278, 0.026329, 0.029008, 0.030631, 0.034425, 0.034866, 0.032780, 0.035932, 0.031235, 0.033309, 0.030911, 0.028444, 0.023708, 0.012258, 0.010890, -0.001815, -0.004289, -0.013623, -0.036897
#*# 	-0.004910, 0.009364, 0.008717, 0.017225, 0.024493, 0.021576, 0.023135, 0.025869, 0.020663, 0.022279, 0.024962, 0.029926, 0.028129, 0.030522, 0.033679, 0.028979, 0.029921, 0.028608, 0.026180, 0.019216, 0.009936, 0.001803, -0.004104, -0.013438, -0.017077, -0.029935
#*# 	-0.002634, 0.004795, 0.009866, 0.012620, 0.017681, 0.019291, 0.023177, 0.020199, 0.018385, 0.019964, 0.023828, 0.027686, 0.028087, 0.025952, 0.022413, 0.024472, 0.024287, 0.021857, 0.017134, 0.007844, 0.005417, -0.000484, -0.013253, -0.018046, -0.024003, -0.043866
#*# 	-0.010711, 0.002506, 0.000711, 0.006918, 0.015433, 0.011322, 0.019737, 0.014512, 0.013841, 0.013145, 0.015867, 0.020879, 0.021330, 0.020375, 0.017875, 0.022228, 0.023177, 0.017319, 0.017134, 0.003316, 0.000847, -0.010765, -0.017879, -0.024972, -0.032072, -0.041552
#*# 	-0.009550, -0.004429, 0.002977, 0.003467, 0.008551, 0.011322, 0.011776, 0.011082, 0.010413, 0.008592, 0.014771, 0.016332, 0.017924, 0.015785, 0.013370, 0.015414, 0.012999, 0.008254, 0.004626, -0.003510, -0.007175, -0.015368, -0.029379, -0.030745, -0.036712, -0.057877
#*# 	-0.018839, -0.009064, -0.006266, 0.001160, 0.006212, 0.006733, 0.007192, 0.005352, 0.004686, 0.005160, 0.009062, 0.009534, 0.012277, 0.011275, 0.011047, 0.010862, 0.009538, 0.009374, 0.001217, -0.005800, -0.015182, -0.019980, -0.028222, -0.036527, -0.043681, -0.054364
#*# 	-0.018860, -0.012525, -0.007423, 0.001159, -0.000655, 0.004437, 0.007170, 0.005352, 0.005834, 0.004054, 0.006778, 0.011775, 0.009979, 0.008956, 0.008770, 0.007464, 0.006158, 0.003688, -0.002218, -0.010394, -0.020951, -0.022292, -0.036341, -0.040018, -0.048330, -0.067249
#*# 	-0.029339, -0.010222, -0.017833, -0.003419, -0.000655, -0.000166, 0.002616, 0.003078, 0.001245, 0.001720, -0.000098, 0.004963, 0.007715, 0.006714, 0.007649, 0.005201, 0.003872, 0.002544, -0.003362, -0.012697, -0.019795, -0.029194, -0.037505, -0.044661, -0.050666, -0.064891
#*# 	-0.028169, -0.013686, -0.014343, -0.008084, -0.007543, -0.000166, 0.000317, -0.000350, -0.001013, -0.000573, 0.001050, 0.004963, 0.005409, 0.004428, 0.004242, 0.001773, -0.000703, -0.001992, -0.010209, -0.019609, -0.025575, -0.030374, -0.045621, -0.046993, -0.057692, -0.081425
#*# 	-0.037533, -0.014850, -0.024823, -0.011540, -0.007562, -0.007051, -0.004291, -0.001520, -0.007923, -0.006305, -0.002391, 0.002672, 0.002021, 0.002144, 0.001958, -0.001662, -0.002992, -0.003177, -0.007913, -0.019609, -0.029028, -0.036156, -0.044475, -0.055164, -0.060043, -0.074326
#*# 	-0.035202, -0.021820, -0.022492, -0.012681, -0.014496, -0.009400, -0.008908, -0.006109, -0.007923, -0.007434, -0.002353, 0.001528, -0.000271, -0.000147, -0.004874, -0.005102, -0.007581, -0.011175, -0.019424, -0.027686, -0.033649, -0.043105, -0.054979, -0.057507, -0.069453, -0.087323
#*# 	-0.044579, -0.025304, -0.030629, -0.015000, -0.013354, -0.012873, -0.013496, -0.008414, -0.012502, -0.009741, -0.006970, -0.004167, -0.003687, -0.004689, -0.007172, -0.009653, -0.012141, -0.012326, -0.020580, -0.026509, -0.037135, -0.046605, -0.052638, -0.062171, -0.069453, -0.081425
#*# 	-0.038691, -0.026492, -0.024784, -0.018486, -0.017975, -0.011678, -0.012337, -0.010687, -0.012540, -0.009741, -0.009251, -0.004186, -0.005985, -0.007025, -0.009511, -0.011975, -0.012141, -0.018067, -0.026324, -0.035785, -0.042959, -0.050110, -0.063160, -0.065700, -0.071811, -0.093270
#*# 	-0.046936, -0.024152, -0.032988, -0.019650, -0.016815, -0.014031, -0.013496, -0.010726, -0.014850, -0.012046, -0.012711, -0.008765, -0.009432, -0.011605, -0.011770, -0.015409, -0.016748, -0.021512, -0.025204, -0.035785, -0.046420, -0.050110, -0.059672, -0.066878, -0.076503, -0.083795
#*# 	-0.038725, -0.029983, -0.029458, -0.021977, -0.021465, -0.016330, -0.014672, -0.012997, -0.015989, -0.016667, -0.013864, -0.013373, -0.015191, -0.017345, -0.016378, -0.018868, -0.022482, -0.026139, -0.033279, -0.042736, -0.049925, -0.055965, -0.067888, -0.073956, -0.078851, -0.099234
#*# 	-0.049301, -0.029982, -0.035313, -0.024310, -0.019136, -0.016314, -0.018131, -0.015333, -0.019481, -0.020122, -0.018485, -0.017990, -0.015191, -0.018498, -0.018683, -0.021161, -0.023675, -0.028453, -0.033279, -0.042735, -0.051113, -0.057137, -0.066693, -0.071608, -0.083610, -0.093269
#*# 	-0.039883, -0.034666, -0.031801, -0.028940, -0.026085, -0.018633, -0.018149, -0.022268, -0.020622, -0.023581, -0.023078, -0.017989, -0.019769, -0.023119, -0.024444, -0.025768, -0.030588, -0.034254, -0.040255, -0.049743, -0.056951, -0.061800, -0.073770, -0.078683, -0.088327, -0.107574
#*# 	-0.042224, -0.029983, -0.035313, -0.028940, -0.023791, -0.024429, -0.022772, -0.024590, -0.024102, -0.025939, -0.024258, -0.020300, -0.022118, -0.024278, -0.025583, -0.030404, -0.031749, -0.035415, -0.041421, -0.048608, -0.059301, -0.065346, -0.073770, -0.081020, -0.090722, -0.101622
#*# 	-0.039866, -0.037017, -0.032988, -0.031315, -0.028416, -0.026756, -0.027427, -0.029244, -0.028733, -0.030551, -0.027738, -0.022578, -0.029032, -0.028892, -0.032538, -0.035027, -0.036374, -0.042403, -0.047218, -0.054424, -0.063999, -0.070042, -0.085612, -0.088142, -0.097856, -0.117182
#*# 	-0.051663, -0.032324, -0.039972, -0.033619, -0.026124, -0.032589, -0.029760, -0.031578, -0.032189, -0.035210, -0.030040, -0.029533, -0.031351, -0.032372, -0.034859, -0.039702, -0.039867, -0.042364, -0.048406, -0.056766, -0.066323, -0.075948, -0.083239, -0.090519, -0.099049, -0.109976
#*# 	-0.044579, -0.037017, -0.038835, -0.035959, -0.037774, -0.033740, -0.032052, -0.037395, -0.036873, -0.037502, -0.035842, -0.034183, -0.036001, -0.039311, -0.041808, -0.044324, -0.046848, -0.049369, -0.056580, -0.064993, -0.073400, -0.079498, -0.090334, -0.095281, -0.103813, -0.128010
#*# 	-0.051646, -0.036978, -0.045856, -0.035959, -0.035433, -0.036080, -0.034424, -0.038544, -0.040358, -0.039840, -0.039359, -0.038803, -0.038327, -0.041662, -0.041808, -0.046662, -0.050355, -0.051712, -0.058931, -0.067332, -0.075728, -0.083020, -0.090334, -0.102447, -0.108590, -0.118386
#*# 	-0.046970, -0.044072, -0.043533, -0.042966, -0.042428, -0.037251, -0.041409, -0.043227, -0.045042, -0.046859, -0.045185, -0.042320, -0.045290, -0.048628, -0.048852, -0.051341, -0.055021, -0.056395, -0.067129, -0.074396, -0.078127, -0.087771, -0.102261, -0.107203, -0.116997, -0.141336
#*# min_x = 86.29
#*# min_y = 84.29
#*# max_x = 213.71
#*# max_y = 211.71
#*# x_count = 26
#*# y_count = 26
#*# mesh_x_pps = 0
#*# mesh_y_pps = 0
#*# algo = bicubic
#*# tension = 0.2
#*#
#*# [cartographer scan_model default]
#*# coefficients = 1.3835667507544025,1.8481099429917467,0.8195084978480336,0.3932645500813253,0.5249814035516346,0.6053861915750819,-0.3061178785531031,-0.5615204591363654,0.37844587923348894,0.41673161177860035
#*# domain = 3.1806737644619784e-07,3.3553413653895606e-07
#*# z_offset = 0
#*# reference_temperature = 26.61
#*#
#*# [cartographer touch_model default]
#*# threshold = 1783
#*# speed = 2
#*# z_offset = -0.05
