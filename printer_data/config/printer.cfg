[include chopper_tune.cfg]
# This file contains common pin mappings for the Fysetc Spider board.
# To use this config, the firmware should be compiled for the STM32F446.
# When calling "menuconfig", enable "extra low-level configuration setup"
# and select the "12MHz crystal" as clock reference
# For flashing, write the compiled klipper.bin to memory location 0x08000000

# See docs/Config_Reference.md for a description of parameters.

## Voron Design VORON2 300 Spider TMC2209 UART config

[respond]
[include mainsail.cfg]                  # Include configuration from mainsail.cfg file
[include CONFIGS/brusharm.cfg]
[include CONFIGS/toolhead.cfg]
[include CONFIGS/stepper_drivers.cfg]
[include CONFIGS/fans.cfg]
[include CONFIGS/temp_sensors.cfg]
[include CONFIGS/toolhead_leds.cfg]
[include CONFIGS/KAMP_Settings.cfg]
[include CONFIGS/print_progress_RGB.cfg]
[include K-ShakeTune/*.cfg]
[include MACROS/*.cfg]
[include shell_command.cfg]

#[include mmu/base/*.cfg]
#[include mmu/optional/client_macros.cfg]
#[include mmu/addons/blobifier.cfg]

[exclude_object]

[mcu]
#serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_4A001D001851303439363932-if00
serial: /dev/ttyAMA0
restart_method: command

[mcu NH36]
serial: /dev/serial/by-id/usb-Klipper_rp2040_4E363334320EA5B9-if00
restart_method: command

#[mcu easybrd]
#serial: /dev/serial/by-id/usb-Klipper_samd21g18a_766557303338585020312E31322F08FF-if00
#restart_method: command

[printer]                             # Printer configuration
kinematics: corexy                    # Printer type: corexy
max_velocity: 600                     # Maximum velocity (max 300)
max_accel: 50000                      # Maximum acceleration (max 4000)
max_z_velocity: 50                    # Maximum Z-axis velocity
max_z_accel: 100                      # Maximum Z-axis acceleration
#minimum_cruise_ratio: 0.5             # Default 0.5
square_corner_velocity: 25            # or ? 25 Square corner velocity

[input_shaper]
#shaper_freq_x: 71.4
#shaper_type_x: mzv
#shaper_freq_y: 49.4
#shaper_type_y: mzv

[skew_correction]

[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results
number_of_results_to_keep: 3
show_macros_in_webui: True

[virtual_sdcard]
path: ~/printer_data/gcodes

[display_status]

[pause_resume]

[gcode_arcs]
resolution: 0.5 


#####################################################################
#      X/Y Stepper Settings
#####################################################################

[stepper_x]
##	Connected to X-MOT (B Motor)
step_pin: PE11
dir_pin: PE10
enable_pin: !PE9
rotation_distance: 40 #39.9
microsteps: 32 #32
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin:  ^NH36:gpio13
position_min: 0
position_endstop: 299.5
position_max: 300.5
homing_speed: 100  #Max 100
second_homing_speed: 20
homing_retract_speed: 100
homing_retract_dist: 5
homing_positive_dir: true

[stepper_y]
##	Connected to Y-MOT (A Motor)
step_pin: PD8
dir_pin: PB12
enable_pin: !PD9
rotation_distance: 40 #39.95
microsteps: 32 #32
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: ^PB13 #tmc2209_stepper_y:virtual_endstop
position_min: 0
position_endstop: 308.5
position_max: 308.5
homing_speed: 100  #Max 100
second_homing_speed: 20
homing_retract_speed: 100
homing_retract_dist: 5
homing_positive_dir: true

[stepper_z]
step_pin: PE2
dir_pin: !PE4
enable_pin: !PE3
rotation_distance: 4
full_steps_per_rotation: 200
microsteps: 32
endstop_pin: probe:z_virtual_endstop # use cartographer as virtual endstop
homing_retract_dist: 0
position_max: 241
position_min: -10.5
homing_speed: 20


[stepper_z1]
step_pin: PD12
dir_pin: !PC4
enable_pin: !PE8
rotation_distance: 4
full_steps_per_rotation: 200
microsteps: 32

[stepper_z2]
step_pin: PE6
dir_pin: !PC13
enable_pin: !PE5
rotation_distance: 4
full_steps_per_rotation: 200
microsteps: 32

#####################################################################
#   Bed Heater
#####################################################################
[heater_bed]
heater_pin: PB4
sensor_type: NTC 100K MGB18-104F39050L32 #Generic 3950 #NTC 100K MGB18-104F39050L32
sensor_pin: PC0 # Spider v2.x
max_power: 0.8
min_temp: 5
max_temp: 125
#control: pid
#pid_kp: 32.475
#pid_ki: 1.012
#pid_kd: 260.615

#####################################################################
#	LED Control
#####################################################################
[output_pin Chamber_LED]
pin: PC8
pwm:true
shutdown_value: 0
value:0.1                             #the brightness at startup (0-1)
cycle_time: 0.0005
#scale: 0.15

#####################################################################
#	Displays
#####################################################################

#[display]
#	mini12864 LCD Display
#lcd_type: uc1701
#cs_pin: PC11
#a0_pin: PD2
#rst_pin: PC10
#encoder_pins: ^PC6,^PC7
#click_pin: ^!PA8
#contrast: 63
#spi_bus: spi1
#spi_software_mosi_pin: PA7
#spi_software_miso_pin: PA6
#spi_software_sclk_pin: PA5

#####################################################################
#	Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

#simply to remove the messages about t0 and t1 not being recognized in the console
[gcode_macro T0]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T0"
    # do nothing
[gcode_macro T1]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T1"
    # do nothing
[gcode_macro T2]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T2"
    # do nothing    
[gcode_macro T3]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T3"
    # do nothing
[gcode_macro T4]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T4"
    # do nothing    
[gcode_macro T5]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T5"
    # do nothing    
[gcode_macro T6]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T6"
    # do nothing
[gcode_macro T7]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T7"
    # do nothing    
[gcode_macro T8]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T8"
    # do nothing    
[gcode_macro T9]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T9"
    # do nothing    
[gcode_macro T10]
gcode:
  SET_DISPLAY_TEXT MSG="Switching Color T10"
    # do nothing    

#####################################################################
##                  Bed Mesh Calibration
#####################################################################
[bed_mesh]
speed: 400                       # Calibration speed
horizontal_move_z: 10            # Z-axis movement speed
mesh_min: 20,35                  # Minimum calibration point coordinates x, y 0 , 0
mesh_max: 280,270                # Maximum calibration point coordinates x, y 300, 293
probe_count: 35,35              # Number of sampling points (7X7 is 49 points)
mesh_pps: 0,0                    # Additional sampling points
adaptive_margin: 10
zero_reference_position: 150,150

####################################################################################
##                                    Homing Override
####################################################################################

#[safe_z_home]
#home_xy_position: 150, 150
#z_hop: 10

#[homing_override]
#axes: z                    # Override homing for the Z axis only
#set_position_z: 0           # Set the Z position to 0 after homing
#gcode:
#    G90                     # Set to absolute positioning mode
#    G0 Z10 F1200            # Move Z axis to 10mm above the bed at 1200 mm/min
#    G28 X                   # Home X axis
#    G28 Y                   # Home Y axis
#    G1 X150 Y150 F7200      # Move to a specific coordinate (125, 125) at 7200 mm/min
#    G28 Z                   # Home Z axis again

[homing_override]
axes: xyz
set_position_z: 0
gcode:
  {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}
  STATUS_LEVELING
  G90                     # Set to absolute positioning mode
  G0 Z10 F1200            # Move Z axis to 10mm above the bed at 1200 mm/min

  {% if home_all or 'X' in params %}
    _HOME_X
  {% endif %}
  
  {% if home_all or 'Y' in params %}
    _HOME_Y
  {% endif %}
  
  {% if home_all or 'Z' in params %}
    STATUS_CALIBRATING_Z
    G90
    G1 X150 Y150 F4500
    G28 Z
    G1 Z10
  {% endif %}

[gcode_macro _HOME_X]
gcode:
    SAVE_GCODE_STATE NAME=STATE_HOME_X
    # Always use consistent run_current on A/B steppers during sensorless homing
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2240 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2240 stepper_y'].run_current|float %}
    {% set HOME_CURRENT = 0.5 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}

    # Home
    G28 X
    # Move away
    G91
    G1 X-80 F6000
    
    # Wait just a second… (give StallGuard registers time to clear)
    G4 P1000
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    RESTORE_GCODE_STATE NAME=STATE_HOME_X

[gcode_macro _HOME_Y]
gcode:
    SAVE_GCODE_STATE NAME=STATE_HOME_Y
    # Set current for sensorless homing
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2240 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2240 stepper_y'].run_current|float %}
    {% set HOME_CURRENT = 0.5 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}

    # Home
    G28 Y
    # Move away
    G91
    G1 Y-150 F6000

    # Wait just a second… (give StallGuard registers time to clear)
    G4 P1000
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    RESTORE_GCODE_STATE NAME=STATE_HOME_Y


####################################################################################
##                                    Z Tilt Adjustment
####################################################################################
[z_tilt]
##  Use Z_TILT_ADJUST to level the bed.
##  z_positions: Location of toolhead

## Uncomment below for 300mm build
z_positions:
   -50, 18
   150, 348
   350, 18
points:
   30, 10
   150, 250
   270, 10

## Uncomment below for 300mm build
#z_positions:
#   -50, 18
#   150, 348
#   350, 18
#points:
#   30, 5
#   150, 245
#   270, 5


speed: 250                 # Speed of Z tilt adjustment
horizontal_move_z: 2       # Z axis move speed for adjustments
retries: 10                # Number of retries for adjustment points
retry_tolerance: 0.0075    # Retry tolerance for adjustment accuracy

[gcode_macro Z_TILT_ADJUST]
rename_existing: BASE_Z_TILT_ADJUST
gcode:
    # Pass 1: Initial Coarse Leveling
    BASE_Z_TILT_ADJUST HORIZONTAL_MOVE_Z=10 RETRY_TOLERANCE=1
    # Pass 2: Fine Leveling and Accuracy
    BASE_Z_TILT_ADJUST HORIZONTAL_MOVE_Z=2

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_freq_x = 71.4
#*# shaper_type_x = mzv
#*# shaper_freq_y = 49.4
#*# shaper_type_y = mzv
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 32.475
#*# pid_ki = 1.012
#*# pid_kd = 260.615
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 41.329
#*# pid_ki = 4.305
#*# pid_kd = 99.192
#*#
#*# [axis_twist_compensation]
#*# z_compensations = 0.035147, 0.004554, -0.018615, -0.020978, -0.000109
#*# compensation_start_x = 20.0
#*# compensation_end_x = 280.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.025793, 0.035320, 0.041168, 0.046922, 0.048877, 0.054632, 0.056614, 0.058546, 0.056732, 0.058658, 0.064321, 0.069991, 0.068173, 0.070927, 0.066986, 0.068659, 0.066655, 0.066391, 0.058756, 0.054830, 0.043371, 0.035621, 0.024116, 0.016347, 0.004755, -0.003152
#*# 	  0.025705, 0.031597, 0.037378, 0.043143, 0.045183, 0.050906, 0.054732, 0.054796, 0.054856, 0.054914, 0.056840, 0.062538, 0.057022, 0.063411, 0.063225, 0.063040, 0.062855, 0.058942, 0.051276, 0.043596, 0.032118, 0.028080, 0.016533, 0.008669, -0.002966, -0.010809
#*# 	  0.018060, 0.023887, 0.029779, 0.035560, 0.041325, 0.043286, 0.045321, 0.047191, 0.045456, 0.047400, 0.049346, 0.055023, 0.053205, 0.055942, 0.055757, 0.053702, 0.055386, 0.051461, 0.047532, 0.036071, 0.024487, 0.020509, 0.008934, 0.004853, -0.010583, -0.018490
#*# 	  0.014228, 0.020068, 0.025971, 0.033662, 0.037576, 0.039507, 0.045242, 0.039690, 0.041610, 0.043559, 0.045582, 0.047528, 0.049460, 0.048458, 0.048195, 0.048088, 0.047902, 0.043888, 0.039947, 0.028451, 0.018799, 0.012922, 0.001224, -0.006606, -0.016427, -0.026283
#*# 	  0.010391, 0.016242, 0.022157, 0.027922, 0.033742, 0.035715, 0.037690, 0.035872, 0.034057, 0.036018, 0.041741, 0.043693, 0.045710, 0.044630, 0.044444, 0.044337, 0.040388, 0.040132, 0.032410, 0.022776, 0.016903, 0.005312, -0.006341, -0.014276, -0.022162, -0.030153
#*# 	  0.006459, 0.012410, 0.018250, 0.024153, 0.026144, 0.031924, 0.030106, 0.028288, 0.030185, 0.028447, 0.034201, 0.039923, 0.038184, 0.037104, 0.036997, 0.040574, 0.032780, 0.032674, 0.022961, 0.017089, 0.009305, -0.006156, -0.014090, -0.021977, -0.029968, -0.041774
#*# 	  -0.001246, 0.004729, 0.010592, 0.014559, 0.026064, 0.028048, 0.024409, 0.024492, 0.022678, 0.024617, 0.030422, 0.030493, 0.032451, 0.029563, 0.033151, 0.032966, 0.032780, 0.025122, 0.017274, 0.009411, 0.001639, -0.010067, -0.021791, -0.029693, -0.037709, -0.045659
#*# 	  -0.008983, -0.001096, 0.006755, 0.008775, 0.014702, 0.020474, 0.018612, 0.016882, 0.018876, 0.017058, 0.022838, 0.024811, 0.026786, 0.025784, 0.025599, 0.025413, 0.025228, 0.017459, 0.013478, 0.001781, -0.009882, -0.013905, -0.029552, -0.033650, -0.045474, -0.053538
#*# 	  -0.012857, -0.006845, 0.002911, 0.008775, 0.006957, 0.016616, 0.014798, 0.013068, 0.015068, 0.013162, 0.015200, 0.019083, 0.019203, 0.020096, 0.019911, 0.021621, 0.021435, 0.013663, 0.005780, -0.002039, -0.013719, -0.017837, -0.029597, -0.037523, -0.051314, -0.059352
#*# 	  -0.014797, -0.006934, -0.001027, 0.001094, 0.006957, 0.008970, 0.007233, 0.009160, 0.011166, 0.009348, 0.013296, 0.013422, 0.015366, 0.014405, 0.016117, 0.017830, 0.013848, 0.013663, 0.001966, -0.005865, -0.017563, -0.025461, -0.037338, -0.045288, -0.057212, -0.065269
#*# 	  -0.020667, -0.010757, -0.008752, -0.002764, -0.004582, 0.003220, 0.003321, 0.001503, 0.003520, 0.001702, 0.003798, 0.009526, 0.007752, 0.006794, 0.008473, 0.010152, 0.006194, 0.005965, -0.005679, -0.013534, -0.021501, -0.033190, -0.045103, -0.049270, -0.064993, -0.073120
#*# 	  -0.024514, -0.014675, -0.012619, -0.004772, -0.004582, 0.001301, 0.003321, -0.000416, -0.000311, -0.002129, 0.005664, 0.005756, 0.007708, 0.002893, 0.002707, 0.002522, 0.002337, -0.001669, -0.013349, -0.017377, -0.029226, -0.041032, -0.049084, -0.057072, -0.069006, -0.077055
#*# 	  -0.028412, -0.018554, -0.016493, -0.006619, -0.006509, -0.002542, -0.002483, -0.002334, -0.004149, -0.002129, -0.000115, 0.001892, 0.003982, 0.002893, 0.002707, -0.001210, -0.001483, -0.005494, -0.013349, -0.021235, -0.031115, -0.041032, -0.052892, -0.060982, -0.072934, -0.080996
#*# 	  -0.032315, -0.022440, -0.016493, -0.010570, -0.008437, -0.002542, -0.004360, -0.006178, -0.004149, -0.005967, -0.000115, 0.001892, 0.000075, -0.000927, -0.001112, -0.005124, -0.005309, -0.013164, -0.017192, -0.028952, -0.036967, -0.048809, -0.056886, -0.064898, -0.076869, -0.085042
#*# 	  -0.032360, -0.022440, -0.020372, -0.014437, -0.012299, -0.002542, -0.004449, -0.002379, -0.007992, -0.006055, -0.005866, -0.001933, -0.003751, -0.004753, -0.004938, -0.008955, -0.009141, -0.017007, -0.021049, -0.029041, -0.040847, -0.052797, -0.060706, -0.068820, -0.078840, -0.088896
#*# 	  -0.032315, -0.022440, -0.020372, -0.014437, -0.012387, -0.006480, -0.004360, -0.006178, -0.007992, -0.006055, -0.003947, -0.005765, -0.007583, -0.006669, -0.008770, -0.008955, -0.012978, -0.019020, -0.024986, -0.036782, -0.044777, -0.052797, -0.064713, -0.072749, -0.084758, -0.092956
#*# 	  -0.032315, -0.022440, -0.020372, -0.014437, -0.012387, -0.006440, -0.008218, -0.010116, -0.011930, -0.009810, -0.007785, -0.007684, -0.007583, -0.012422, -0.012607, -0.012793, -0.016910, -0.020864, -0.028855, -0.040661, -0.048624, -0.056701, -0.064668, -0.072749, -0.084758, -0.092956
#*# 	  -0.032315, -0.026332, -0.020372, -0.018311, -0.012387, -0.010255, -0.012073, -0.013891, -0.011930, -0.011823, -0.007873, -0.009602, -0.011420, -0.014388, -0.012607, -0.016636, -0.020679, -0.024801, -0.032723, -0.044547, -0.052566, -0.060611, -0.068635, -0.080625, -0.088810, -0.100894
#*# 	  -0.032405, -0.030229, -0.024258, -0.022190, -0.016255, -0.014116, -0.015934, -0.013971, -0.011930, -0.017523, -0.011628, -0.013490, -0.011420, -0.016310, -0.016495, -0.020494, -0.020760, -0.024801, -0.036596, -0.048438, -0.056425, -0.064527, -0.072564, -0.080724, -0.092770, -0.104873
#*# 	  -0.036270, -0.030319, -0.024303, -0.026076, -0.020128, -0.018073, -0.019891, -0.017752, -0.017676, -0.021473, -0.015485, -0.015419, -0.019161, -0.020203, -0.024244, -0.024430, -0.024615, -0.032538, -0.040476, -0.052426, -0.062339, -0.072378, -0.080439, -0.088625, -0.100709, -0.112850
#*# 	  -0.040187, -0.034133, -0.028150, -0.026076, -0.024008, -0.021946, -0.023675, -0.021709, -0.023523, -0.025252, -0.019341, -0.021159, -0.023057, -0.024019, -0.028114, -0.030189, -0.032352, -0.036411, -0.044361, -0.056240, -0.068219, -0.076313, -0.084436, -0.092585, -0.104688, -0.116848
#*# 	  -0.040232, -0.038088, -0.032137, -0.029967, -0.027894, -0.025826, -0.023764, -0.025537, -0.027396, -0.029125, -0.023291, -0.025109, -0.026927, -0.027929, -0.031981, -0.036040, -0.040105, -0.044176, -0.052151, -0.060240, -0.072193, -0.080353, -0.092300, -0.100424, -0.108673, -0.120953
#*# 	  -0.040232, -0.038133, -0.032137, -0.033955, -0.031785, -0.029712, -0.027644, -0.029462, -0.031276, -0.029214, -0.031032, -0.028977, -0.030794, -0.031796, -0.035855, -0.039920, -0.043991, -0.048068, -0.059965, -0.064156, -0.076128, -0.084300, -0.096366, -0.104502, -0.112665, -0.128880
#*# 	  -0.040232, -0.038133, -0.035951, -0.033865, -0.031785, -0.027769, -0.029587, -0.029462, -0.031276, -0.033094, -0.034912, -0.028977, -0.034668, -0.039549, -0.039735, -0.041863, -0.045937, -0.051966, -0.060055, -0.068079, -0.080069, -0.084201, -0.098352, -0.104502, -0.116663, -0.133005
#*# 	  -0.044154, -0.042050, -0.039951, -0.035862, -0.031785, -0.033603, -0.035421, -0.033347, -0.035206, -0.036979, -0.034912, -0.036730, -0.038547, -0.039549, -0.043620, -0.047697, -0.051870, -0.055870, -0.063971, -0.072007, -0.082042, -0.092214, -0.100338, -0.108488, -0.120717, -0.133005
#*# 	  -0.044154, -0.042050, -0.039951, -0.033865, -0.035683, -0.033648, -0.035421, -0.037239, -0.039053, -0.036979, -0.038797, -0.040615, -0.042433, -0.043435, -0.047557, -0.051595, -0.055684, -0.055960, -0.067893, -0.075942, -0.087969, -0.096180, -0.108302, -0.112479, -0.124778, -0.137035
#*# min_x = 86.26
#*# min_y = 84.26
#*# max_x = 213.74
#*# max_y = 211.74
#*# x_count = 26
#*# y_count = 26
#*# mesh_x_pps = 0
#*# mesh_y_pps = 0
#*# algo = bicubic
#*# tension = 0.2
#*#
#*# [cartographer scan_model default]
#*# coefficients = 1.4409646153265558,1.919197424113448,0.8571935870808074,0.41993384838137965,0.38750915051252216,0.4038583397037419,-0.13471668025995048,-0.285877455006765,0.2506859237579534,0.24614886855284263
#*# domain = 3.24103401852879e-07,3.359738087586886e-07
#*# z_offset = 0
#*# reference_temperature = 24.97
#*#
#*# [cartographer touch_model default]
#*# threshold = 1067
#*# speed = 2
#*# z_offset = -0.05
#*#
#*# [cartographer]
#*# z_backlash = 0.00528
