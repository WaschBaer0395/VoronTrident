[gcode_macro TEST_TMC_VALUES]
gcode:
    {% set STEPPER = params.STEPPER|default("stepper_x") %}
    {% set TOFF_START = params.TOFF_START|default(2)|int %}
    {% set TOFF_END = params.TOFF_END|default(8)|int %}
    {% set TOFF_STEP = params.TOFF_STEP|default(1)|int %}
    {% set TBLANK_START = params.TBLANK_START|default(1)|int %}
    {% set TBLANK_END = params.TBLANK_END|default(4)|int %}
    {% set TBLANK_STEP = params.TBLANK_STEP|default(1)|int %}
    {% set MOVE_DISTANCE = params.MOVE_DISTANCE|default(10)|int %} ; in mm
    {% set DELAY = params.DELAY|default(1000)|int %} ; in ms

    {% for TOFF in range(TOFF_START, TOFF_END + 1, TOFF_STEP) %}
        {% for TBLANK in range(TBLANK_START, TBLANK_END + 1, TBLANK_STEP) %}
            M117 Testing TOFF={TOFF} TBLANK={TBLANK}
            { action_respond_info("Testing TOFF=%d TBLANK=%d" % (TOFF, TBLANK)) } ; Print to console
            SET_TMC_FIELD STEPPER={STEPPER} FIELD=toff VALUE={TOFF}
            SET_TMC_FIELD STEPPER={STEPPER} FIELD=tblank VALUE={TBLANK}
            G4 P{DELAY} ; dwell
            G91 ; relative positioning
            G0 F1000 {STEPPER[7].upper()}={MOVE_DISTANCE} ; Move the specified stepper
            G4 P{DELAY}
            G0 F1000 {STEPPER[7].upper()}=-{MOVE_DISTANCE}
            G90 ; absolute positioning
        {% endfor %}
    {% endfor %}
    M117 Test Finished